<!doctype html><html><head>
  <meta charset="utf-8" />
  <title>Slide Drive Tests</title>  
</head><body>
  <ul id="results"></ul>
  <div id="workingArea"></div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="../external/jquery/jquery-1.7.min.js"><\/script>')</script>
<script src="atesting.js"></script>
<script>
"use strict";

var tests = atest( "Slide Drive Tests", function ( assert, pass, toCleanUp ) {
  function getFramedWindow ( path, toCleanUp ) {
    var el = document.createElement( "iframe" );
    el.src = path;
    el.width = 1280
    el.height = 768;
    document.getElementById( "workingArea" ).appendChild( el );
    toCleanUp(function () {
      document.getElementById( "workingArea" ).removeChild( el );
    })
    return el.contentWindow;
  }

  function getAsBlob ( path, type ) {
    // Syncronously produces a Blob of the file at the specified path.

    var bb = new ( window.BlobBuilder || window.WebKitBlobBuilder || window.MozBlobBuilder ),
        src = $.ajax( path, { async: false } ).responseText;
    bb.append( src );
    return bb.getBlob( type );
  }

  var testSvg = getAsBlob( "test-presentation.svg", "image/svg+xml" ),
      testSvg_slideCount = 9;
  
  atest( "../index.html", function ( assert, pass, toCleanUp ) {
    atest( "Popcorn, jQuery and Deck.js initialized.", function ( assert, pass, toCleanUp ) {
      var frame = getFramedWindow( "../index.html", toCleanUp );

      return function poll () {
        return ( frame.Popcorn && frame.jQuery && frame.jQuery.deck ) ? true : poll;
      }
    } );

    atest( "Popcorn instance exposed on window (for testing).", function ( assert, pass, toCleanUp ) {
      var frame = getFramedWindow( "../index.html", toCleanUp );

      return function poll () {
        return ( frame.popcorn ) ? true : poll;
      }
    } );

    atest( "_slideDriveReady is set (for testing).", function ( assert, pass, toCleanUp ) {
      var frame = getFramedWindow( "../index.html", toCleanUp );

      return function poll () {
        return ( frame._slideDriveReady ) ? true : poll;
      }
    } );

    atest( "Moving in Deck must move in Popcorn.", function ( assert, pass, toCleanUp ) {
      var frame = getFramedWindow( "../index.html", toCleanUp );

      return function poll () {
        return ( frame._slideDriveReady ) ? onReady : poll;
      }
  
      function onReady () {
        var previousTime = frame.popcorn.currentTime();
        frame.jQuery.deck( "next" );
        assert( frame.popcorn.currentTime() > previousTime, "Advancing Deck.js must instantly advance Popcorn." );   
    
        return afterMove;
      }
  
      function afterMove () {
        var previousTime = frame.popcorn.currentTime();
        frame.jQuery.deck( "prev" );
        assert( frame.popcorn.currentTime() < previousTime, "Going back in Deck.js must instantly go back in Popcorn." );   
    
        return true;
      }
    } );

    atest( "Transcript must correspond to current slide", function ( assert, pass, toCleanUp ) {
      var frame = getFramedWindow( "../index.html", toCleanUp );

      return function poll () {
        return ( frame._slideDriveReady ) ? onReady : poll;
      }

      function onReady () {
        frame.jQuery.deck( "go", 0 );
        assert( /a quick introduction/.test( frame.document.querySelector( ".popcorn-transcript" ).textContent ),
                "After going to slide 0, transcript must contain 'a quick introduction'." );
        frame.jQuery.deck( "go", 1 );
        assert( ! /a quick introduction/.test( frame.document.querySelector( ".popcorn-transcript" ).textContent ),
                "After going to slide 1, transcript must not contain 'a quick introduction'." );
        assert( /to help scientists/.test( frame.document.querySelector( ".popcorn-transcript" ).textContent ),
                "After going to slide 1, transcript must contain 'to help scientists'." );
      }
    } );

    atest( "Anchor links must be respected", function ( assert, pass, toCleanUp ) {
      var frame = getFramedWindow( "../index.html#slide-1", toCleanUp );

      return function poll () {
        return ( frame._slideDriveReady ) ? onReady : poll;
      }

      function onReady () {
        assert( /to help scientists/.test( frame.document.querySelector( ".popcorn-transcript" ).textContent ),
                "After loading presentation, transcript must contain 'to help scientists'." );
      }
    } );
  } );

  atest( "./template.html", function ( assert, pass, toCleanUp ) {
    atest( "Popcorn, Butter, jQuery and Deck.js initialized.", function ( assert, pass, toCleanUp ) {
      var frame = getFramedWindow( "../template.html", toCleanUp );

      return function poll () {
        return ( frame.Popcorn && frame.Butter && frame.jQuery && frame.jQuery.deck ) ? true : poll;
      }
    } );

    atest( "Popcorn and Butter instances exposed on window (for testing).", function ( assert, pass, toCleanUp ) {
      var frame = getFramedWindow( "../template.html", toCleanUp );

      return function poll () {
        return ( frame.popcorn && frame.butter ) ? true : poll;
      }
    } );

    atest( "_slideDriveReady is set (for testing).", function ( assert, pass, toCleanUp ) {
      var frame = getFramedWindow( "../template.html", toCleanUp );

      return function poll () {
        return ( frame._slideDriveReady ) ? true : poll;
      }
    } );

    atest( "Playing advances > 2.75 seconds in 3 seconds.", function ( assert, pass, toCleanUp ) {
      var frame = getFramedWindow( "../template.html", toCleanUp );

      return function pollReady () {
        return ( frame._slideDriveReady ) ? onReady : pollReady;
      }

      function onReady () {
        var start = new Date;
        frame.popcorn.play();

        return function pollAdvancement () {
          var delta = (new Date - start);

          assert( delta < 3750, "three seconds must not pass" );

          return ( frame.popcorn.currentTime() >= 2.75 ) ? true : pollAdvancement;
        };
      }
    } );

    atest( "Exported HTML doesn't include rendered MediaElement controls.", function ( assert, pass, toCleanUp ) {
      var frame = getFramedWindow( "../template.html", toCleanUp );

      return function pollReady () {
        return ( frame._slideDriveReady ) ? onReady : pollReady;
      }

      function onReady () {
        var html = frame.butter.page.getHTML();

        assert( ! /mejs-/.test( html ), "HTML must not contain MediaElement controls (\"mejs-\")." );

        pass();
      }
    } );

    atest( "Triggering filesdropped on track produces any new events.", function ( asssert, pass, toCleanUp ) {
      var frame = getFramedWindow( "../template.html", toCleanUp );

      return function pollReady () {
        return ( ! frame._slideDriveReady ) ? pollReady : function () {
          frame.butter.tracks[ 0 ].view.dispatch( "filesdropped", {
            files: [ testSvg ],
            track: frame.butter.tracks[ 0 ],
            start: 5
          } );
      
          return pollDone;
        };
      }
  
      function pollDone () {
        return ( frame.butter.tracks[ 0 ].trackEvents.length > 1 ) ? true : pollDone;
      }
    } );

    atest( "Triggering filesdropped on track produces enough events.", function ( assert, pass, toCleanUp ) {
      var frame = getFramedWindow( "../template.html", toCleanUp );

      return function pollReady () {
        return ( ! frame._slideDriveReady ) ? pollReady : function () {
          frame.butter.tracks[ 0 ].view.dispatch( "filesdropped", {
            files: [ testSvg ],
            track: frame.butter.tracks[ 0 ],
            start: 5
          } );
      
          return pollDone;
        };
      }
  
      function pollDone () {
        return ( frame.butter.tracks[ 0 ].trackEvents.length >= 1 + testSvg_slideCount ) ? true : pollDone;
      }
    } );

    atest( "Triggering filesdropped on track with multiple files produces enough events.",
    function ( assert, pass, toCleanUp ) {
      var frame = getFramedWindow( "../template.html", toCleanUp );

      return function pollReady () {
        return ( ! frame._slideDriveReady ) ? pollReady : function () {
          frame.butter.tracks[ 0 ].view.dispatch( "filesdropped", {
            files: [ testSvg, testSvg ],
            track: frame.butter.tracks[ 0 ],
            start: 5
          } );
      
          return pollDone;
        };
      }
  
      function pollDone () {
        return ( frame.butter.tracks[ 0 ].trackEvents.length >= 1 + testSvg_slideCount + testSvg_slideCount ) ? true : pollDone;
      }
    } );

    atest( "Reordering events should reorder corresponding DOM elements",
    function ( assert, pass, toCleanUp ) {
      var frame = getFramedWindow( "../template.html", toCleanUp );

      return function pollReady () {
        return ( ! frame._slideDriveReady ) ? pollReady : function () {
          frame.butter.tracks[ 0 ].view.dispatch( "filesdropped", {
            files: [ testSvg, testSvg ],
            track: frame.butter.tracks[ 0 ],
            start: 5
          } );
      
          return pollDropped;
        };
      }
  
      function pollDropped () {
        return ( frame.butter.tracks[ 0 ].trackEvents.length >= 2 ) ? onReady : pollDropped;
      }
  
      function onReady () {
        var events = frame.butter.tracks[ 0 ].trackEvents,
            firstElement = frame.document.getElementById( events[ 0 ].popcornOptions.slideId ),
            secondElement = frame.document.getElementById( events[ 1 ].popcornOptions.slideId )
    
        assert( firstElement.compareDocumentPosition(secondElement) === firstElement.DOCUMENT_POSITION_FOLLOWING,
                "Elements must be in correct order before reordering." );
    
        events[ 0 ].popcornOptions.start = 1;
        events[ 1 ].popcornOptions.start = 0;
    
        assert( firstElement.compareDocumentPosition(secondElement) === firstElement.DOCUMENT_POSITION_PRECEDING,
                "Elements must be in correct order after reordering." );
    
        return true;
      }
    } );

    // case "SKIP":

    atest( "Event time changes must be reflected in corresponding DOM elements",
    function ( assert, pass, toCleanUp ) {
      var frame = getFramedWindow( "../template.html", toCleanUp );

      return function pollReady () {
        return ( ! frame._slideDriveReady ) ? pollReady : onReady;
      }
  
      function onReady () {
        var events = frame.butter.tracks[ 0 ].trackEvents,
            el = frame.document.getElementById( events[ 0 ].popcornOptions.slideId );
    
        for ( var i = 0; i < 5; i++ ) {
          events[ 0 ].popcornOptions.start = i;
          assert( String( i ) === el.getAttribute( "data-popcorn-slideshow" ),
                  "data-popcorn-slideshow must reflect value of .start, " + i );
        }
    
        return true;
      }
    } );
  });
});

document.getElementById( "results" ).appendChild( tests.report );

</script>
<style>
  body {
    font-family: sans-serif;
  }
  
  ul {
    margin: 0;
    padding: .25em .5em;
  }
  
  li {
    list-style-type: none;
    padding: .125em;
    background: #FFE;
    padding-left: .5em;
    
    border: 2px outset #BBB;
    border-left: .25em solid #FF8;
    margin: .25em;
  }
  
  li.pass {
    border-left: .25em solid green;
    background: #EFE;
  }

  li.fail {
    border-left: .25em solid red;
    background: #FEE;
  }
  
  .label {
    font-weight: bold;
  }

  #workingArea {
    min-height: 1em;
    max-height: 320px;
    margin: 2em;
    border: 1px dashed #D88;
    background: white;
    overflow: auto;
  }
</style>
</body></html>
